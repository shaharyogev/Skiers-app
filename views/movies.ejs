<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ski Rental</title>
  <link rel='stylesheet' href='/stylesheets/admin.css' />
  <link rel='shortcut icon' href='/images/favicon.ico' />

</head>

<body>
  <div id='mainPage'>

    <div class='navColumn'>
      <div class='navLogo flex-row'>

        <div class='logoImg'>
          <svg height="100%" viewBox="0 0 512 512" width="100%" fill="rgb(255, 255, 255)" xmlns="http://www.w3.org/2000/svg">
            <path d="m338.5 178h-15v257.734375h-13.828125v-257.734375h-15v32.5h-76.75v15h17.191406l-29.691406 45.277344v-92.777344h-15v257.734375h-13.828125v-257.734375h-15v257.734375h-29.578125v38.289063h43.992187v37.976562h15v-37.976562h43.992188v-38.289063h-29.578125v-54.617187h76.75v-15h-17.285156l29.785156-45.421876v115.039063h-29.578125v38.289063h43.992188v37.976562h15v-37.976562h43.992187v-38.289063h-29.578125zm-118.5 272.734375v8.289063h-72.980469v-8.289063zm33.050781-225.234375h24.0625l-30.164062 46h-24.0625zm-6.101562 140.617188h-24.0625l30.164062-46h24.0625zm-29.027344-61v15h17.191406l-29.691406 45.277343v-78.894531h76.75v-15h-17.285156l29.785156-45.421875v79.039063zm135.15625 145.617187v8.289063h-72.984375v-8.289063zm0 0" />
            <path d="m230.257812 136.925781-12.09375-12.089843h-4.40625v-124.835938h-60.496093v124.832031h-4.410157l-12.09375 12.09375v28.574219h93.5zm-61.996093-29.09375h17.996093v-15h-17.996093v-15.332031h17.996093v-15h-17.996093v-15.5h17.996093v-15h-17.996093v-17h30.496093v109.832031h-30.496093zm46.996093 42.667969h-63.5v-7.359375l3.308594-3.308594h56.886719l3.304687 3.308594zm0 0" />
            <path d="m363.335938 136.925781-12.09375-12.089843h-4.410157v-124.835938h-60.492187v124.832031h-4.410156l-12.09375 12.09375v28.574219h93.5zm-61.996094-29.09375h17.992187v-15h-17.992187v-15.332031h17.992187v-15h-17.992187v-15.5h17.992187v-15h-17.992187v-17h30.492187v109.832031h-30.492187zm46.996094 42.667969h-63.5v-7.359375l3.308593-3.304687h56.886719l3.304688 3.304687zm0 0" />
            <path d="m38 286.5h111.09375v-15h-111.09375c-12.683594 0-23-10.316406-23-23s10.316406-23 23-23h111.09375v-15h-111.09375c-20.953125 0-38 17.046875-38 38s17.046875 38 38 38zm0 0" />
            <path d="m351 225.5h123c12.683594 0 23 10.316406 23 23s-10.316406 23-23 23h-123v15h123c20.953125 0 38-17.046875 38-38s-17.046875-38-38-38h-123zm0 0" />
            <path d="m474 305.117188h-123v15h123c12.683594 0 23 10.320312 23 23 0 12.683593-10.316406 23-23 23h-123v15h123c20.953125 0 38-17.046876 38-38 0-20.953126-17.046875-38-38-38zm0 0" />
            <path d="m149.09375 366.117188h-111.09375c-12.683594 0-23-10.316407-23-23 0-12.679688 10.316406-23 23-23h111.09375v-15h-111.09375c-20.953125 0-38 17.046874-38 38 0 20.953124 17.046875 38 38 38h111.09375zm0 0" />
            <path d="m474 250.5h-73v-15h73zm-83 0h-15v-15h15zm-25 0h-15v-15h15zm0 0" />
            <path d="m474 345.117188h-73v-15h73zm-83 0h-15v-15h15zm-25 0h-15v-15h15zm0 0" />
          </svg>
        </div>
        <h1>Skiers</h1>
      </div>
      <div id='userNameTitle'>

        <h2 id='userName'>
          <%= userName %>
        </h2>
      </div>
      <div>
        <div class='navButtons'>
          <h2>BI Querys</h2>
          <ul>
            <li><a type='button' method='get' action='/movies' onclick="includeThisHTML('/movies')">Movies In Stock </a></li>
            <li><a type='button' method='get' action='/topTenMovies' onclick="includeThisHTML('/topTenMovies')">Top Ten
                Movies </a></li>
            <li><a type='button' method='get' action='/topTenUsers' onclick="includeThisHTML('/topTenUsers')">Top Ten
                Users </a></li>
            <li><a type='button' method='get' action='/mostActiveUser' onclick="includeThisHTML('/mostActiveUser')">Most
                Active User </a></li>
            <li><a type='button' method='get' action='topRentedMovie' onclick="includeThisHTML('/topRentedMovie')">Top
                Rented Movie </a></li>
          </ul>
          <a type="button" class='menuButtonText' onclick="themeToggle('themeToggle')">
            <div id="themeToggle" class="manuBox5">Dark-Side</div>
          </a>
        </div>
      </div>
    </div>
    <div class='mainContent'>
      <div class=" navMenu">
        <div class='flex-space '>
        <div id="menuLogo">
          <div class="menuContainer" onclick="menuX(this)">
            <div class="menuBar1"></div>
            <div class="menuBar2"></div>
            <div class="menuBar3"></div>
          </div>
        </div>
        <h2 class='userNameMenu'>
            <%= userName %>
          </h2>
        </div>
      </div>
      <div id='inventoryTab'>
        <div id='navTab'>
          <a type='button' class='tabNavButton' onclick="tabToggle('a')">Rent</a>
          <a type='button' class='tabNavButton' onclick="tabToggle('b')">Return</a>
          <a type='button' class='tabNavButton' onclick="tabToggle('c')">Inventory</a>
        </div>
        <section id='contentTab'>
          <div id='inventoryTabA' class='form tabBox'>
            <h2>Rent Skis</h2>
            <form id='rentMovie' name='rentmovie' action='/submitrent' onsubmit='return checkForm(id)'>
              <input id='movieTitle' type='text' placeholder='Customer Name' name='title' required>
              <input id='titleInventory' type='number' placeholder='Ski Pairs' name='inventory' required>
              <input id='userEmail' type='text' placeholder='Customer Email' name='email' required>
              <button id='submitInventory' type='submit' class='submitButton '> Submit</button>
              <span class='error'></span>
            </form>
          </div>

          <div id='inventoryTabB' class='form tabBox'>
            <h2>Return Skis</h2>
            <form id='returnMovie' name='rentmovie' action='/submitreturn' onsubmit='return checkForm(id)'>
              <input id='movieTitle' type='text' placeholder='Customer Name' name='title' required>
              <input id='titleInventory' type='number' placeholder='Ski Pairs' name='inventory' required>
              <input id='userEmail' type='text' placeholder='Customer Email' name='email' required>
              <button id='submitInventory' type='submit' class='submitButton'> Submit</button>
              <span class='error'></span>
            </form>
          </div>

          <div id='inventoryTabC' class='form tabBox'>
            <h2>Add / Remove Skis to inventory</h2>
            <form id='addMovie' name='addmovie' action='/addmovietodb' onsubmit='return checkForm(id)'>
              <input id='movieTitle' type='text' placeholder='Customer Name' name='title' required>
              <input id='titleInventory' type='number' placeholder='Ski Pairs' name='inventory' required>
              <button id='submitInventory' type='submit' class='submitButton'> Submit</button>
              <span class='error'></span>
            </form>
          </div>
          <br>
          <br>
        </section>
      </div>


      <div id='querysResults' class='querysResults'>
        <div id='topten' class='topten'>
          <h2 class='title' id='title'>
            <%= title %>
          </h2>
          <h3 class='subTitle' id='status'>
            <%= status %>
          </h3>
          <ul id='queryUl'>
            <% for( var index in moviesList ){  %>
            <li>
              <%= moviesList[index]%>
            </li>
            <% } %>
          </ul>
        </div>
      </div>

      <div id='chatLiveBox' class='chatLiveBox'>
        <div id='chatFlex'>
          <div id='minimize'>
            <div id='chatButtons'>
              <a id='chatButtonToggle' type='button' onclick="minimizeToggle()" class='chatMinimize'>_</a>
            </div>
            <div class='chatMessages'>
              <div class='chatUsersOnline'>
                <h3>Online:</h3>
                <ul id='chatUsersUl'>
                  <li></li>
                </ul>
              </div>
              <div id='chatMessagesBox'>
                <h3>Store Chat:</h3>
                <ul id='chatUl'>
                  <li></li>
                </ul>
              </div>
            </div>
          </div>

          <div id='chatInputDiv'>
            <input class='chatInputTextBox' id='chatInput' type='text' placeholder='Type a message' required>
            <a id='chatSend' type='button'>
              <?xml version="1.0" encoding="iso-8859-1" ?>
              <!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
              <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
              <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                x="0px" y="0px" class='chatSend' width="535.5px" height="535.5px" viewBox="0 0 535.5 535.5" style="enable-background:new 0 0 535.5 535.5;"
                xml:space="preserve">
                <g>
                  <g>
                    <polygon points="0,497.25 535.5,267.75 0,38.25 0,216.75 382.5,267.75 0,318.75"/>
                  </g>
                </g>
              </svg>
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    function pageSize() {
      let page = document.getElementById('mainPage');
      page.style.width = window.innerWidth + 'px';
      page.style.height = window.innerHeight + 'px';
    }
    //pageSize();
    window.onresize = function () {
      //pageSize()
    };

    function tabToggle(l) {
      let inventoryTabA = document.getElementById('inventoryTabA');
      let inventoryTabB = document.getElementById('inventoryTabB');
      let inventoryTabC = document.getElementById('inventoryTabC');
      if (l == 'a') {
        inventoryTabA.style.display = 'flex';
        inventoryTabB.style.display = 'none';
        inventoryTabC.style.display = 'none';
      } else if (l == 'b') {
        inventoryTabA.style.display = 'none';
        inventoryTabB.style.display = 'flex';
        inventoryTabC.style.display = 'none';
      } else {
        inventoryTabA.style.display = 'none';
        inventoryTabB.style.display = 'none';
        inventoryTabC.style.display = 'flex';
      }
    };

    //Chat Toggles
    function minimizeToggle() {
      let button = document.getElementById('chatButtonToggle');
      let chatBox = document.getElementById('chatLiveBox');
      if (button.innerText == '_') {
        button.innerText = '{ }';
        chatBox.setAttribute('class', 'chatLiveBoxMini')
        button.setAttribute('class', 'chatEnlarge')
      } else {
        button.innerText = '_';
        chatBox.setAttribute('class', 'chatLiveBox')
        button.setAttribute('class', 'chatMinimize')
      }
    }

    //menu X/E 
    let menuOpen = 0;
    let menuClass;
    let navColumn = document.getElementById('mainPage');

    function menuX(x, st) {
      x.classList.toggle('change');
      navColumn.classList.toggle('change');
      menuClass = x;
      if (menuOpen === 0) {
        st = setTimeout(function () {
          menuOpen = 1;
        }, 200);
      } else {
        menuOpen = 0;
      }
    }


    //close the menu if the user click anywhere else
    function menuXX() {
      if (menuOpen === 1) {
        menuX(menuClass);
      };
    }
    
    document.body.addEventListener("click", menuXX);

    //Chat
    let socket = io();
    let chatSend = document.getElementById('chatSend');
    let message = document.getElementById('chatInput');
    let chatUl = document.getElementById('chatUl');
    let chatUsersUl = document.getElementById('chatUsersUl');
    let userName = document.getElementById('userName');

    //Send user name to the server

    if (userName) {
      userName = userName.innerText;
      socket.emit('namedUserConnected', {
        userName: userName
      });
    };
    let newUserChatCount = 0;
    let newUserChatColorList = new Array;
    socket.on('newUserConnected', function (d) {
      newUserChatCount++;
      let newUserChatLi = document.createElement('li');
      let newChatH3 = document.createElement('h3');
      newChatH3.appendChild(document.createTextNode(d));
      newUserChatLi.appendChild(newChatH3);
      let colorPickerVar = newUserChatCount % 8;
      newChatH3.style.color = 'var(--c' + colorPickerVar + ')';
      newUserChatLi.setAttribute('class', 'newUserLi');
      newUserChatColorList[d] = 'var(--c' + colorPickerVar + ')';




      //console.log(chatUsersUl.firstElementChild)
      chatUsersUl.insertBefore(newUserChatLi, chatUsersUl.firstElementChild);
    });


    //Emit message + acknowledgement
    function sendMessage() {
      socket.emit('new message', {
        user: userName,
        message: message.value
      }, function (d) {
        console.log(d);
      });
      message.value = '';
    };

    //send message trigers
    chatSend.addEventListener("click", sendMessage);
    message.addEventListener("keydown", function (e) {
      if (e.keyCode === 13) {
        sendMessage();
      }
    });

    //recive message and print to screen
    socket.on('new message', function (d) {
      let newChatLi = document.createElement('li');
      let newChatH3 = document.createElement('h3');
      let newChatP = document.createElement('p');
      let newChatH3Color = newUserChatColorList[d.user];
      console.log(newUserChatColorList[d.user]);
      // newChatLi.appendChild(document.createTextNode(d.user + ': ' + d.message));
      // newChatLi.setAttribute('class', 'newMessageLi');

      newChatH3.appendChild(document.createTextNode(d.user));
      newChatH3.style.color = newChatH3Color;
      newChatP.appendChild(document.createTextNode(d.message));
      newChatLi.appendChild(newChatH3);
      newChatLi.appendChild(newChatP);
      newChatLi.setAttribute('class', 'newMessageLi');
      chatUl.appendChild(newChatLi);
      let messages = chatUl.querySelectorAll('li');
      let lastMessage = messages[messages.length - 1];
      lastMessage.scrollIntoView();
    });


    function checkForm(id) {
      event.preventDefault();
      let formId = document.getElementById(id);
      let formDataNode = formId.querySelectorAll('input');

      //console.log( formDataNode)
      let formAction = formId.action;
      console.log('the action = ' + formAction)
      let titleTest = formId.querySelector('input[name="title"]').value;
      let inventoryTest = formId.querySelector('input[name="inventory"]').value;
      let emailTest;

      if (formId.querySelector('input[name="email"]')) {
        emailTest = formId.querySelector('input[name="email"]').value;
      }

      if (titleTest === ' ' || titleTest === '') {
        formId.querySelector('.error').innerHTML = ' cant use this movie title';
        return false;

      } else if (inventoryTest == 0) {
        formId.querySelector('.error').innerHTML = ' the inventory cant be "0"';
        return false;

      } else {
        postForm(formAction, formDataNode);
      }
    };

    function contentToView(json) {
      obj = JSON.parse(json);
      let titleT = document.getElementById('title')
      titleT.innerText = obj.title;
      let statusT = document.getElementById('status')
      statusT.innerText = obj.status
      let ul = document.getElementById('queryUl');
      ul.innerHTML = '';
      for (i in obj.moviesList) {
        let li = document.createElement('li');
        li.appendChild(document.createTextNode(obj.moviesList[i]));
        ul.appendChild(li);
      }
    };


    function includeThisHTML(page) {
      var z, pagePath, elmnt, file, xhttp;
      elmnt = document.getElementById("topten");
      if (page === 'home') {
        file = 'movies';
        pagePath = '/';
      } else {
        file = page;
        pagePath = '?' + file;
      }

      if (file) {
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              contentToView(this.responseText);
            }
            if (this.status == 404) {
              contentToView({
                title: 'We have a little problem',
                status: '',
                queryUl: ''
              }); //DEV
            }
          }
        }
        xhttp.open("GET", file, true);
        xhttp.send();
        return;
      }
    };

    function postForm(file, formDataNode) {

      let i, pagePath, elmnt, xhttp, formData;
      formData = new FormData();
      pagePath = file;
      for (i in formDataNode) {
        formData.append(formDataNode[i].name, formDataNode[i].value);
      };
      elmnt = document.getElementById("topten");

      xhttp = new XMLHttpRequest();

      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) {
            console.log(this.response);
            contentToView(this.responseText);
          }
          if (this.status == 404) {
            contentToView({
              title: 'We have a little problem',
              status: '',
              queryUl: ''
            }); //DEV
          }
        }
      }
      xhttp.open('POST', pagePath, false);
      xhttp.send(formData);

    };


    //Forms
    /*
    (function(){
    function checkForm(id){
      let formId = document.getElementById(id);
      let titleTest = formId.querySelector('input[name="title"]').value;
      /* email validation - deactivated on testing.
      let emailTest = formId.querySelector('input[name="email"]');
      if(emailTest != undefined){
        let re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        let res =  re.test(String(emailTest.value).toLowerCase());
        console.log('email is: '+ res);
        formId.querySelector('.error').innerHTML = 'cant use this email: ' + res;
      }
      */
    /*
  socket.emit('form data', titleTest);
  if(titleTest === ' ' || titleTest === ''){
    formId.querySelector('.error').innerHTML = 'cant use this movie title';
    return false;
  };
};

let submitClick = document.getElementById('submitInventory');
submitClick.addEventListener("click", function(){
  console.log('button was clicked')
  socket.emit('submit', submitClick.id);
});

socket.on('form data', function(d){
  let ul = document.getElementById('queryUl');
  let li = document.createElement('li');
  li.appendChild(document.createTextNode(d));
  ul.appendChild(li)
});
})();
*/
  </script>
</body>

</html>